<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linux 系统监控平台</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f5f5f5;display:flex}
    .sidebar{width:200px;background:#2c3e50;color:white;height:100vh;padding:20px 0;box-sizing:border-box}
    .sidebar h2{text-align:center;margin:0 0 30px 0;font-size:18px;color:#ecf0f1}
    .nav-item{display:block;padding:12px 20px;color:#bdc3c7;text-decoration:none;border-bottom:1px solid #34495e;cursor:pointer}
    .nav-item:hover,.nav-item.active{background:#34495e;color:#ecf0f1}
    .main-content{flex:1;padding:20px;overflow-y:auto}
    .page{display:none}
    .page.active{display:block}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
    .card{background:white;padding:15px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);text-align:center}
    .card h3{margin:0 0 10px 0;font-size:14px;color:#666}
    .card .value{font-size:24px;font-weight:bold;margin:5px 0}
    .card.normal .value{color:#27ae60}
    .card.warning .value{color:#f39c12}
    .card.critical .value{color:#e74c3c}
    .charts{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
    .chart-container{background:white;padding:15px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);height:220px}
    .chart-container h3{margin:0 0 15px 0;font-size:16px;color:#333}
    .table-wrapper{max-height:400px;overflow-y:auto}
    table{width:100%;border-collapse:collapse;background:white;border-radius:8px;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
    th{background:#34495e;color:white;padding:12px;text-align:left;font-weight:bold}
    td{padding:12px;border-bottom:1px solid #ecf0f1}
    tr:hover{background:#f8f9fa}
    th,td{border:1px solid #ddd;padding:6px;text-align:left;font-size:14px}
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>系统监控</h2>
        <a class="nav-item active" onclick="showPage('overview')">系统概览</a>
        <a class="nav-item" onclick="showPage('processes')">进程 Top-N</a>
    </div>

    <div class="main-content">
        <!-- 系统概览页面 -->
        <div id="overview" class="page active">
            <h1>系统监控概览</h1>
            
            <!-- 状态卡片 -->
            <div class="cards">
                <div class="card" id="cpu-card">
                    <h3>CPU 使用率</h3>
                    <div class="value" id="cpu-value">--</div>
                </div>
                <div class="card" id="memory-card">
                    <h3>内存使用率</h3>
                    <div class="value" id="memory-value">--</div>
                </div>
                <div class="card" id="disk-card">
                    <h3>磁盘使用率</h3>
                    <div class="value" id="disk-value">--</div>
                </div>
                <div class="card" id="network-card">
                    <h3>网络流量</h3>
                    <div class="value" id="network-value">--</div>
                </div>
            </div>

            <!-- 监控图表 -->
            <div class="charts">
                <div class="chart-container">
                    <h3>CPU 使用率 (%)</h3>
                    <canvas id="cpuChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <h3>内存使用率 (%)</h3>
                    <canvas id="memoryChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <h3>磁盘使用率 (%)</h3>
                    <canvas id="diskChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <h3>网络流量 (Mbps)</h3>
                    <canvas id="networkChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- 进程Top-N页面 -->
        <div id="processes" class="page">
            <h1>进程 Top-N（按 CPU%）</h1>
            <div class="table-wrapper">
                <table id="topTable">
                    <thead>
                        <tr>
                            <th>PID</th>
                            <th>用户</th>
                            <th>进程名</th>
                            <th>CPU%</th>
                            <th>内存%</th>
                        </tr>
                    </thead>
                    <tbody id="topTableBody">
                        <tr><td colspan="5">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    let currentPage = 'overview';
    let charts = {};
    let data = {cpu: [], memory: [], disk: [], networkRecv: [], networkSent: []};
    let maxDataPoints = 50;
    let config = {};

    // 页面切换
    function showPage(pageId) {
        // 更新导航状态
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        event.target.classList.add('active');
        
        // 更新页面显示
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        
        currentPage = pageId;
    }

    // 初始化图表
    function initCharts() {
        const chartConfig = {
            type: 'line',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {display: false},
                    y: {beginAtZero: true, max: 100}
                },
                plugins: {
                    legend: {display: false},
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#fff',
                        borderWidth: 1,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return '时间: ' + context[0].label;
                            },
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                            }
                        }
                    }
                },
                elements: {point: {radius: 0, hoverRadius: 4}},
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        };

        charts.cpu = new Chart(document.getElementById('cpuChart'), {
            ...chartConfig,
            data: {
                labels: [],
                datasets: [{
                    label: 'CPU%',
                    data: [],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true
                }]
            }
        });

        charts.memory = new Chart(document.getElementById('memoryChart'), {
            ...chartConfig,
            data: {
                labels: [],
                datasets: [{
                    label: '内存%',
                    data: [],
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    fill: true
                }]
            }
        });

        charts.disk = new Chart(document.getElementById('diskChart'), {
            ...chartConfig,
            data: {
                labels: [],
                datasets: [{
                    label: '磁盘%',
                    data: [],
                    borderColor: '#f39c12',
                    backgroundColor: 'rgba(243, 156, 18, 0.1)',
                    fill: true
                }]
            }
        });

        const networkConfig = {...chartConfig};
        networkConfig.options.scales.y.max = undefined;
        networkConfig.options.plugins.tooltip.callbacks.label = function(context) {
            return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' Mbps';
        };
        charts.network = new Chart(document.getElementById('networkChart'), {
            ...networkConfig,
            data: {
                labels: [],
                datasets: [
                    {
                        label: '接收',
                        data: [],
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        fill: false
                    },
                    {
                        label: '发送',
                        data: [],
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        fill: false
                    }
                ]
            }
        });
        charts.network.options.plugins.legend.display = true;
    }

    // 更新图表数据
    function updateCharts(newData) {
        const timestamp = new Date().toLocaleTimeString();
        
        ['cpu', 'memory', 'disk'].forEach(type => {
            data[type].push(newData[type]);
            if (data[type].length > maxDataPoints) {
                data[type].shift();
            }
            
            charts[type].data.labels.push(timestamp);
            charts[type].data.datasets[0].data = [...data[type]];
            if (charts[type].data.labels.length > maxDataPoints) {
                charts[type].data.labels.shift();
            }
            charts[type].update('none');
        });

        // 网络图表
        data.networkRecv.push(newData.network_recv_mbps);
        data.networkSent.push(newData.network_sent_mbps);
        if (data.networkRecv.length > maxDataPoints) {
            data.networkRecv.shift();
            data.networkSent.shift();
        }
        
        charts.network.data.labels.push(timestamp);
        charts.network.data.datasets[0].data = [...data.networkRecv];
        charts.network.data.datasets[1].data = [...data.networkSent];
        if (charts.network.data.labels.length > maxDataPoints) {
            charts.network.data.labels.shift();
        }
        charts.network.update('none');
    }

    // 更新状态卡片
    function updateCards(data) {
        const thresholds = config.thresholds || {};
        
        // CPU卡片
        const cpuCard = document.getElementById('cpu-card');
        const cpuValue = document.getElementById('cpu-value');
        cpuValue.textContent = data.cpu.toFixed(1) + '%';
        cpuCard.className = 'card ' + getThresholdClass(data.cpu, thresholds.cpu);
        
        // 内存卡片
        const memoryCard = document.getElementById('memory-card');
        const memoryValue = document.getElementById('memory-value');
        memoryValue.textContent = data.memory.toFixed(1) + '%';
        memoryCard.className = 'card ' + getThresholdClass(data.memory, thresholds.memory);
        
        // 磁盘卡片
        const diskCard = document.getElementById('disk-card');
        const diskValue = document.getElementById('disk-value');
        diskValue.textContent = data.disk.toFixed(1) + '%';
        diskCard.className = 'card ' + getThresholdClass(data.disk, thresholds.disk);
        
        // 网络卡片
        const networkCard = document.getElementById('network-card');
        const networkValue = document.getElementById('network-value');
        networkValue.textContent = `${data.network_recv_mbps.toFixed(1)} · ${data.network_sent_mbps.toFixed(1)} Mbps`;
        const networkTotal = data.network_recv_mbps + data.network_sent_mbps;
        networkCard.className = 'card ' + getThresholdClass(networkTotal, thresholds.network);
    }

    function getThresholdClass(value, threshold) {
        if (!threshold) return 'normal';
        if (value >= threshold.critical) return 'critical';
        if (value >= threshold.warning) return 'warning';
        return 'normal';
    }

    // 获取系统数据
      async function fetchData() {
          if (currentPage !== 'overview') return;
          
          try {
              const response = await fetch(`${API_BASE}/api/data`);
              const apiData = await response.json();
              
              // API返回格式: {latest: {...}, history: {...}}
              if (apiData.latest) {
                  // 转换数据格式以匹配前端期望
                  const newData = {
                      cpu: apiData.latest.cpu || 0,
                      memory: apiData.latest.mem || 0,
                      disk: apiData.latest.disk || 0,
                      network_recv_mbps: apiData.latest.net_recv || 0,
                      network_sent_mbps: apiData.latest.net_sent || 0
                  };
                  updateCharts(newData);
                  updateCards(newData);
              }
          } catch (error) {
              console.error('获取数据失败:', error);
          }
      }

     // 获取Top-N进程数据
      async function refreshTop() {
          if (currentPage !== 'processes') return;
          
          try {
              const response = await fetch(`${API_BASE}/api/top?count=10&by=cpu`);
              const apiData = await response.json();
              
              const tbody = document.getElementById('topTableBody');
              tbody.innerHTML = '';
              
              // API返回格式: {top: [...], by: "cpu", count: 10}
              const processes = apiData.top || [];
              
              processes.forEach(proc => {
                  const row = tbody.insertRow();
                  row.insertCell(0).textContent = proc.pid;
                  row.insertCell(1).textContent = proc.user;
                  row.insertCell(2).textContent = proc.name;
                  row.insertCell(3).textContent = proc.cpu.toFixed(1) + '%';
                  row.insertCell(4).textContent = proc.mem.toFixed(1) + '%';
              });
              
              if (processes.length === 0) {
                  tbody.innerHTML = '<tr><td colspan="5">暂无进程数据</td></tr>';
              }
          } catch (error) {
              console.error('获取Top进程失败:', error);
              document.getElementById('topTableBody').innerHTML = '<tr><td colspan="5">获取数据失败</td></tr>';
          }
      }

    // API基础URL
     const API_BASE = 'http://127.0.0.1:8000';

     // 加载配置
     async function loadConfig() {
         try {
             const response = await fetch(`${API_BASE}/api/config`);
             config = await response.json();
         } catch (error) {
             console.error('加载配置失败:', error);
         }
     }

     // 初始化
     async function init() {
         await loadConfig();
         initCharts();
         
         // 定时刷新
         setInterval(() => {
             if (currentPage === 'overview') {
                 fetchData();
             } else if (currentPage === 'processes') {
                 refreshTop();
             }
         }, 1000);
         
         // 立即获取一次数据
         fetchData();
         refreshTop();
     }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>