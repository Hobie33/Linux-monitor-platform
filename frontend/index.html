<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linux 系统监控平台</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f5f5f5;display:flex}
    .sidebar{width:200px;background:#2c3e50;color:white;height:100vh;padding:20px 0;box-sizing:border-box}
    .sidebar h2{text-align:center;margin:0 0 30px 0;font-size:18px;color:#ecf0f1}
    .nav-item{display:block;padding:12px 20px;color:#bdc3c7;text-decoration:none;border-bottom:1px solid #34495e;cursor:pointer}
    .nav-item:hover,.nav-item.active{background:#34495e;color:#ecf0f1}
    .main-content{flex:1;padding:20px;overflow-y:auto}
    .page{display:none}
    .page.active{display:block}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
    .card{background:white;padding:15px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);text-align:center}
    .card h3{margin:0 0 10px 0;font-size:14px;color:#666}
    .card .value{font-size:24px;font-weight:bold;margin:5px 0}
    .card.normal .value{color:#27ae60}
    .card.warning .value{color:#f39c12}
    .card.critical .value{color:#e74c3c}
    .charts{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
    .chart-container{background:white;padding:15px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);height:220px}
    .chart-container h3{margin:0 0 15px 0;font-size:16px;color:#333}
    .table-wrapper{max-height:400px;overflow-y:auto}
    table{width:100%;border-collapse:collapse;background:white;border-radius:8px;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
    th{background:#34495e;color:white;padding:12px;text-align:left;font-weight:bold}
    td{padding:12px;border-bottom:1px solid #ecf0f1}
    tr:hover{background:#f8f9fa}
    th,td{border:1px solid #ddd;padding:6px;text-align:left;font-size:14px}
    .status-chip{display:inline-block;padding:4px 8px;border-radius:999px;background:#eee;color:#666;font-size:12px}
    .badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:12px;color:#fff}
    .badge-warning{background:#f39c12}
    .badge-critical{background:#e74c3c}
    .badge-ok{background:#27ae60}
    .row-warning{background:#fff8e6}
    .row-critical{background:#ffecec}
    .controls{display:flex;gap:10px;align-items:center;margin:10px 0}
    .controls select,.controls input{padding:6px;border:1px solid #ccc;border-radius:4px}
    .controls button{padding:6px 10px;border:1px solid #34495e;background:#34495e;color:#fff;border-radius:4px;cursor:pointer}
    .controls button.secondary{background:#666;border-color:#666}
    .table-wrapper thead th{position:sticky;top:0;z-index:1}
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>系统监控</h2>
        <a class="nav-item active" onclick="showPage('overview')">系统概览</a>
        <a class="nav-item" onclick="showPage('processes')">进程 Top-N</a>
        <a class="nav-item" onclick="showPage('rules')">规则</a>
        <a class="nav-item" onclick="showPage('events')">事件流</a>
    </div>

    <div class="main-content">
        <!-- 系统概览页面 -->
        <div id="overview" class="page active">
            <h1>系统监控概览</h1>
            
            <!-- 状态卡片 -->
            <div class="cards">
                <div class="card" id="cpu-card">
                    <h3>CPU 使用率</h3>
                    <div class="value" id="cpu-value">--</div>
                </div>
                <div class="card" id="memory-card">
                    <h3>内存使用率</h3>
                    <div class="value" id="memory-value">--</div>
                </div>
                <div class="card" id="disk-card">
                    <h3>磁盘使用率</h3>
                    <div class="value" id="disk-value">--</div>
                </div>
                <div class="card" id="network-card">
                    <h3>网络流量</h3>
                    <div class="value" id="network-value">--</div>
                </div>
            </div>

            <!-- 监控图表 -->
            <div class="charts">
                <div class="chart-container">
                    <h3>CPU 使用率 (%)</h3>
                    <canvas id="cpuChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <h3>内存使用率 (%)</h3>
                    <canvas id="memoryChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <h3>磁盘使用率 (%)</h3>
                    <canvas id="diskChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <h3>网络流量 (Mbps)</h3>
                    <canvas id="networkChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- 进程Top-N页面 -->
        <div id="processes" class="page">
            <h1>进程 Top-N（按 CPU%）</h1>
            <div class="table-wrapper">
                <table id="topTable">
                    <thead>
                        <tr>
                            <th>PID</th>
                            <th>用户</th>
                            <th>进程名</th>
                            <th>CPU%</th>
                            <th>内存%</th>
                        </tr>
                    </thead>
                    <tbody id="topTableBody">
                        <tr><td colspan="5">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 规则页面 -->
        <div id="rules" class="page">
            <h1>当前规则</h1>
            <div class="controls">
                <span class="status-chip" id="rulesSummary">加载中...</span>
            </div>
            <div class="table-wrapper">
                <table id="rulesTable">
                    <thead>
                        <tr>
                            <th>名称</th>
                            <th>指标</th>
                            <th>阈值</th>
                            <th>比较符</th>
                            <th>级别</th>
                            <th>连续次数</th>
                            <th>冷却(s)</th>
                        </tr>
                    </thead>
                    <tbody id="rulesTableBody">
                        <tr><td colspan="7">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 事件流页面 -->
        <div id="events" class="page">
            <h1>事件流</h1>
            <div class="controls">
                <span class="status-chip" id="sseStatus">未连接</span>
                <select id="filterLevel" onchange="onFilterChange()">
                    <option value="all">全部级别</option>
                    <option value="warning">warning</option>
                    <option value="critical">critical</option>
                </select>
                <select id="filterType" onchange="onFilterChange()">
                    <option value="all">全部类型</option>
                    <option value="metric_threshold">metric_threshold</option>
                    <option value="backend_start">backend_start</option>
                </select>
                <input id="filterText" type="text" placeholder="关键字..." oninput="onFilterChange()" />
                <button id="toggleStreamBtn" onclick="toggleStream()">暂停</button>
            </div>
            <div class="table-wrapper">
                <table id="eventsTable">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>级别</th>
                            <th>类型</th>
                            <th>规则</th>
                            <th>指标</th>
                            <th>消息</th>
                            <th>源</th>
                        </tr>
                    </thead>
                    <tbody id="eventsTableBody">
                        <tr><td colspan="7">等待事件...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
    let currentPage = 'overview';
    let charts = {};
    let data = {cpu: [], memory: [], disk: [], networkRecv: [], networkSent: []};
    let maxDataPoints = 50;
    let config = {};
    let thresholds = {};
    let sse = null;
    let eventsList = [];
    let eventFilter = { level: 'all', type: 'all', text: '' };
    let streamPaused = false;

    // 页面切换
    function showPage(pageId) {
        // 更新导航状态
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        event.target.classList.add('active');
        
        // 更新页面显示
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        
        currentPage = pageId;
        if (currentPage === 'rules') {
            loadRules();
        } else if (currentPage === 'events') {
            refreshEvents();
            if (!streamPaused) connectSSE();
        } else {
            disconnectSSE();
        }
    }

    // 初始化图表
    function initCharts() {
        const chartConfig = {
            type: 'line',
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {display: false},
                    y: {beginAtZero: true, max: 100}
                },
                plugins: {
                    legend: {display: false},
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#fff',
                        borderWidth: 1,
                        displayColors: true,
                        callbacks: {
                            title: function(context) {
                                return '时间: ' + context[0].label;
                            },
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                            }
                        }
                    }
                },
                elements: {point: {radius: 0, hoverRadius: 4}},
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        };

        charts.cpu = new Chart(document.getElementById('cpuChart'), {
            ...chartConfig,
            data: {
                labels: [],
                datasets: [{
                    label: 'CPU%',
                    data: [],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    fill: true
                }]
            }
        });

        charts.memory = new Chart(document.getElementById('memoryChart'), {
            ...chartConfig,
            data: {
                labels: [],
                datasets: [{
                    label: '内存%',
                    data: [],
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    fill: true
                }]
            }
        });

        charts.disk = new Chart(document.getElementById('diskChart'), {
            ...chartConfig,
            data: {
                labels: [],
                datasets: [{
                    label: '磁盘%',
                    data: [],
                    borderColor: '#f39c12',
                    backgroundColor: 'rgba(243, 156, 18, 0.1)',
                    fill: true
                }]
            }
        });

        const networkConfig = {...chartConfig};
        networkConfig.options.scales.y.max = undefined;
        networkConfig.options.plugins.tooltip.callbacks.label = function(context) {
            return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' Mbps';
        };
        charts.network = new Chart(document.getElementById('networkChart'), {
            ...networkConfig,
            data: {
                labels: [],
                datasets: [
                    {
                        label: '接收',
                        data: [],
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        fill: false
                    },
                    {
                        label: '发送',
                        data: [],
                        borderColor: '#9b59b6',
                        backgroundColor: 'rgba(155, 89, 182, 0.1)',
                        fill: false
                    }
                ]
            }
        });
        charts.network.options.plugins.legend.display = true;
    }

    // 更新图表数据
    function updateCharts(newData) {
        const timestamp = new Date().toLocaleTimeString();
        
        ['cpu', 'memory', 'disk'].forEach(type => {
            data[type].push(newData[type]);
            if (data[type].length > maxDataPoints) {
                data[type].shift();
            }
            
            charts[type].data.labels.push(timestamp);
            charts[type].data.datasets[0].data = [...data[type]];
            if (charts[type].data.labels.length > maxDataPoints) {
                charts[type].data.labels.shift();
            }
            charts[type].update('none');
        });

        // 网络图表
        data.networkRecv.push(newData.network_recv_mbps);
        data.networkSent.push(newData.network_sent_mbps);
        if (data.networkRecv.length > maxDataPoints) {
            data.networkRecv.shift();
            data.networkSent.shift();
        }
        
        charts.network.data.labels.push(timestamp);
        charts.network.data.datasets[0].data = [...data.networkRecv];
        charts.network.data.datasets[1].data = [...data.networkSent];
        if (charts.network.data.labels.length > maxDataPoints) {
            charts.network.data.labels.shift();
        }
        charts.network.update('none');
    }

    // 更新状态卡片
    function updateCards(data) {
        
        // CPU卡片
        const cpuCard = document.getElementById('cpu-card');
        const cpuValue = document.getElementById('cpu-value');
        cpuValue.textContent = data.cpu.toFixed(1) + '%';
        cpuCard.className = 'card ' + getThresholdClass(data.cpu, thresholds.cpu);
        
        // 内存卡片
        const memoryCard = document.getElementById('memory-card');
        const memoryValue = document.getElementById('memory-value');
        memoryValue.textContent = data.memory.toFixed(1) + '%';
        memoryCard.className = 'card ' + getThresholdClass(data.memory, thresholds.memory);
        
        // 磁盘卡片
        const diskCard = document.getElementById('disk-card');
        const diskValue = document.getElementById('disk-value');
        diskValue.textContent = data.disk.toFixed(1) + '%';
        diskCard.className = 'card ' + getThresholdClass(data.disk, thresholds.disk);
        
        // 网络卡片
        const networkCard = document.getElementById('network-card');
        const networkValue = document.getElementById('network-value');
        networkValue.textContent = `${data.network_recv_mbps.toFixed(1)} · ${data.network_sent_mbps.toFixed(1)} Mbps`;
        const networkTotal = data.network_recv_mbps + data.network_sent_mbps;
        networkCard.className = 'card ' + getThresholdClass(networkTotal, thresholds.network);
    }

    function getThresholdClass(value, threshold) {
        if (!threshold) return 'normal';
        const w = Number(threshold.warning);
        const c = Number(threshold.critical);
        if (!isFinite(w) && !isFinite(c)) return 'normal';
        const cw = isFinite(w) ? w : (isFinite(c) ? c / 1.25 : undefined);
        const cc = isFinite(c) ? c : (isFinite(w) ? w * 1.25 : undefined);
        if (isFinite(cc) && value >= cc) return 'critical';
        if (isFinite(cw) && value >= cw) return 'warning';
        return 'normal';
    }

    // 获取系统数据
      async function fetchData() {
          if (currentPage !== 'overview') return;
          
          try {
              const response = await fetch(`${API_BASE}/api/data`);
              const apiData = await response.json();
              
              // API返回格式: {latest: {...}, history: {...}}
              if (apiData.latest) {
                  // 转换数据格式以匹配前端期望
                  const newData = {
                      cpu: apiData.latest.cpu || 0,
                      memory: apiData.latest.mem || 0,
                      disk: apiData.latest.disk || 0,
                      network_recv_mbps: apiData.latest.net_recv || 0,
                      network_sent_mbps: apiData.latest.net_sent || 0
                  };
                  updateCharts(newData);
                  updateCards(newData);
              }
          } catch (error) {
              console.error('获取数据失败:', error);
          }
      }

     // 获取Top-N进程数据
     async function refreshTop() {
          if (currentPage !== 'processes') return;
          
          try {
              const response = await fetch(`${API_BASE}/api/top?count=10&by=cpu`);
              const apiData = await response.json();
              
              const tbody = document.getElementById('topTableBody');
              tbody.innerHTML = '';
              
              // API返回格式: {top: [...], by: "cpu", count: 10}
              const processes = apiData.top || [];
              
              processes.forEach(proc => {
                  const row = tbody.insertRow();
                  row.insertCell(0).textContent = proc.pid;
                  row.insertCell(1).textContent = proc.user;
                  row.insertCell(2).textContent = proc.name;
                  row.insertCell(3).textContent = proc.cpu.toFixed(1) + '%';
                  row.insertCell(4).textContent = proc.mem.toFixed(1) + '%';
              });
              
              if (processes.length === 0) {
                  tbody.innerHTML = '<tr><td colspan="5">暂无进程数据</td></tr>';
              }
          } catch (error) {
              console.error('获取Top进程失败:', error);
              document.getElementById('topTableBody').innerHTML = '<tr><td colspan="5">获取数据失败</td></tr>';
          }
      }

     async function loadRules() {
         try {
             const response = await fetch(`${API_BASE}/api/rules`);
             const apiData = await response.json();
             const rules = (apiData.rules || []).map(r => ({
                 name: r.name,
                 metric: r.metric,
                 threshold: r.threshold,
                 comparator: r.comparator,
                 severity: r.severity,
                 consecutive: r.consecutive,
                 cooldown_sec: r.cooldown_sec
             }));
             const tbody = document.getElementById('rulesTableBody');
             tbody.innerHTML = '';
             if (rules.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="7">暂无规则</td></tr>';
                 document.getElementById('rulesSummary').textContent = '0 条规则';
                 return;
              }
              rules.forEach(r => {
                  const row = tbody.insertRow();
                  row.insertCell(0).textContent = r.name;
                  row.insertCell(1).textContent = r.metric;
                 row.insertCell(2).textContent = formatThreshold(r.metric, r.threshold);
                 row.insertCell(3).textContent = r.comparator;
                 const sev = row.insertCell(4);
                 const badge = document.createElement('span');
                 badge.className = 'badge ' + (r.severity === 'critical' ? 'badge-critical' : 'badge-warning');
                 badge.textContent = r.severity;
                 sev.appendChild(badge);
                 row.insertCell(5).textContent = r.consecutive;
                 row.insertCell(6).textContent = r.cooldown_sec;
              });
             document.getElementById('rulesSummary').textContent = `${rules.length} 条规则`;
         } catch (error) {
             const tbody = document.getElementById('rulesTableBody');
             tbody.innerHTML = '<tr><td colspan="7">加载规则失败</td></tr>';
             document.getElementById('rulesSummary').textContent = '加载失败';
         }
     }

     function formatThreshold(metric, th) {
         if (metric === 'net_recv' || metric === 'net_sent') return `${Number(th).toFixed(2)} Mbps`;
         return `${Number(th).toFixed(1)} %`;
     }

     async function refreshEvents() {
         try {
             const response = await fetch(`${API_BASE}/api/events?limit=50`);
             const apiData = await response.json();
             eventsList = apiData.events || [];
             renderEvents();
         } catch (error) {
             const tbody = document.getElementById('eventsTableBody');
             tbody.innerHTML = '<tr><td colspan="7">加载事件失败</td></tr>';
         }
     }

     function renderEvents() {
         const tbody = document.getElementById('eventsTableBody');
         tbody.innerHTML = '';
         const filtered = applyEventFilters(eventsList || []);
         if (!filtered || filtered.length === 0) {
             tbody.innerHTML = '<tr><td colspan="7">暂无事件</td></tr>';
             return;
         }
         filtered.slice(0, 200).forEach(evt => {
             const row = tbody.insertRow();
             const ts = evt.timestamp || '';
             const level = evt.level || '';
             const type = evt.type || '';
             const ruleName = evt.rule && evt.rule.name ? evt.rule.name : '';
             const metric = evt.metrics ? summarizeMetrics(evt.metrics) : '';
             const msg = evt.message || '';
             const src = evt.source ? summarizeSource(evt.source) : '';
             if (level === 'critical') row.className = 'row-critical';
             else if (level === 'warning') row.className = 'row-warning';
             row.insertCell(0).textContent = ts;
             const lv = row.insertCell(1);
             const badge = document.createElement('span');
             badge.className = 'badge ' + (level === 'critical' ? 'badge-critical' : (level === 'warning' ? 'badge-warning' : 'badge-ok'));
             badge.textContent = level || 'ok';
             lv.appendChild(badge);
             row.insertCell(2).textContent = type;
             row.insertCell(3).textContent = ruleName;
             row.insertCell(4).textContent = metric;
             row.insertCell(5).textContent = msg;
             row.insertCell(6).textContent = src;
         });
     }

     function applyEventFilters(list) {
         return list.filter(evt => {
             if (eventFilter.level !== 'all' && (evt.level || '') !== eventFilter.level) return false;
             if (eventFilter.type !== 'all' && (evt.type || '') !== eventFilter.type) return false;
             const t = eventFilter.text.trim();
             if (t) {
                 const s = JSON.stringify(evt).toLowerCase();
                 if (!s.includes(t.toLowerCase())) return false;
             }
             return true;
         });
     }

     function onFilterChange() {
         eventFilter.level = document.getElementById('filterLevel').value;
         eventFilter.type = document.getElementById('filterType').value;
         eventFilter.text = document.getElementById('filterText').value;
         renderEvents();
     }

     function summarizeMetrics(m) {
         const parts = [];
         if (m.cpu != null) parts.push(`cpu:${Number(m.cpu).toFixed(1)}%`);
         if (m.mem != null) parts.push(`mem:${Number(m.mem).toFixed(1)}%`);
         if (m.disk != null) parts.push(`disk:${Number(m.disk).toFixed(1)}%`);
         if (m.net_recv != null) parts.push(`recv:${Number(m.net_recv).toFixed(2)}Mbps`);
         if (m.net_sent != null) parts.push(`sent:${Number(m.net_sent).toFixed(2)}Mbps`);
         return parts.join(' ');
     }

     function summarizeSource(s) {
         const svc = s.service || '';
         const host = s.host || '';
         const pid = s.pid != null ? String(s.pid) : '';
         return `${svc}@${host}#${pid}`;
     }

     function connectSSE() {
         const statusEl = document.getElementById('sseStatus');
         if (sse) sse.close();
         sse = new EventSource(`${API_BASE}/api/events/stream`);
         sse.onopen = () => { statusEl.textContent = '已连接'; };
         sse.onerror = () => { statusEl.textContent = '连接错误'; };
         sse.onmessage = (e) => {
             try {
                 const evt = JSON.parse(e.data);
                 if (streamPaused) return;
                 eventsList.unshift(evt);
                 if (eventsList.length > 200) eventsList.pop();
                 renderEvents();
             } catch {}
         };
     }

     function disconnectSSE() {
         const statusEl = document.getElementById('sseStatus');
         if (sse) {
             sse.close();
             sse = null;
         }
         if (statusEl) statusEl.textContent = '未连接';
     }

     function toggleStream() {
         streamPaused = !streamPaused;
         const btn = document.getElementById('toggleStreamBtn');
         btn.textContent = streamPaused ? '继续' : '暂停';
         if (currentPage === 'events') {
             if (streamPaused) disconnectSSE();
             else connectSSE();
         }
     }

    // API基础URL
     const API_BASE = 'http://127.0.0.1:8000';

     // 加载配置
     async function loadConfig() {
         try {
             const response = await fetch(`${API_BASE}/api/config`);
             config = await response.json();
             thresholds = normalizeThresholds(config.thresholds || {});
         } catch (error) {
             console.error('加载配置失败:', error);
         }
     }

     function normalizeThresholds(th) {
         function toObj(val) {
             if (val == null) return null;
             if (typeof val === 'object') {
                 const w = Number(val.warning);
                 const c = Number(val.critical);
                 const cw = isFinite(w) ? w : undefined;
                 const cc = isFinite(c) ? c : (isFinite(w) ? w * 1.25 : undefined);
                 if (cw == null && cc == null) return null;
                 return { warning: cw ?? (cc / 1.25), critical: cc ?? (cw * 1.25) };
             }
             const n = Number(val);
             if (!isFinite(n)) return null;
             return { warning: n, critical: n * 1.25 };
         }
         const cpu = toObj(th.cpu);
         const memory = toObj(th.mem);
         const disk = toObj(th.disk);
         const nr = toObj(th.net_recv);
         const ns = toObj(th.net_sent);
         let network = null;
         if (nr && ns) {
             const nw = (nr.warning ?? 0) + (ns.warning ?? 0);
             const nc = (nr.critical ?? (nr.warning * 1.25)) + (ns.critical ?? (ns.warning * 1.25));
             network = { warning: nw, critical: nc };
         } else {
             network = toObj(th.network);
         }
         return { cpu, memory, disk, network };
     }

     // 初始化
     async function init() {
         await loadConfig();
         initCharts();
         
         // 定时刷新
         setInterval(() => {
             if (currentPage === 'overview') {
                 fetchData();
             } else if (currentPage === 'processes') {
                 refreshTop();
             }
         }, 1000);
         
         // 立即获取一次数据
         fetchData();
         refreshTop();
     }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>